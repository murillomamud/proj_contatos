AppSync={diaSync:null,diaSyncIcon1:null,diaSyncIcon2:null,diaSyncIcon3:null,diaSyncCount1:null,diaSyncCount2:null,diaSyncCount3:null,diaSyncCount4:null,serverUrl:null,db:null,tablesToSync:[],syncInfo:null,syncResult:null,lastSyncDate:0,firstSync:!1,cbEndSync:null,sqlSplit:100,updPackage:0,recPackage:0,numPackage:1,applid:"",checkTable:function(n,e){AppDB.transaction(function(t){t.executeSql('SELECT name, sql FROM sqlite_master WHERE type="table" AND name = ?',[n],function(t,a){var c=a.rows.item(0).sql.replace(/^[^\(]+\(([^\)]+)\)/g,"$1").split(","),s=[];for(i in c)"string"==typeof c[i]&&s.push(c[i].split(" ")[1]);$.each(e,function(e,t){if(-1===s.indexOf(t)){var a="ALTER TABLE "+n+" ADD "+t+" VARCHAR;";try{AppDB.transaction(function(e){e.executeSql(a,[]),console.log("Table: "+n+", added field: "+t)})}catch(c){console.log("Error: Unable to alter table "+c+".")}}})})})},initSync:function(n,e,t,a,c,s){var i=this,o=0;for(this.applid=s,this.db=e,this.serverUrl=a,this.tablesToSync=n,this.syncInfo=t,o=0;o<i.tablesToSync.length;o++)"undefined"==typeof i.tablesToSync[o].idName&&(i.tablesToSync[o].idName="id");i.db.transaction(function(n){i._executeSql("CREATE TABLE IF NOT EXISTS SYNCINFO (key VARCHAR PRIMARY KEY,last_sync TIMESTAMP);",[],n)}),i._selectSql("SELECT last_sync FROM SYNCINFO WHERE key = ?",[i.applid],null,function(n){0===n.length||0==n[0]?(i._executeSql("INSERT OR REPLACE INTO SYNCINFO (key,last_sync) VALUES (?,?)",[i.applid,0]),i.firstSync=!0,i.lastSyncDate=0,i.syncInfo.lastSyncDate=i.lastSyncDate,c(!0)):(i.lastSyncDate=n[0].last_sync,0===i.lastSyncDate&&(i.firstSync=!0),i.syncInfo.lastSyncDate=i.lastSyncDate,c(!1))})},syncNow:function(n,e,t){var a=this;if(null===this.db)throw"You should call the initSync before (db is null)";a.syncResult={syncOK:!1,codeStr:"noSync",message:"No Sync yet",nbSent:0,nbUpdated:0},a.updPackage=0,a.recPackage=0,t?a.numPackage=t:a.numPackage=1,a.createDialog(),a.cbEndSync=function(){n(a.syncResult.message,100,a.syncResult.codeStr),e(a.syncResult)},a._getDataToBackup(function(n){a._sendDataToServer(n,function(n){a._updateLocalDb(n,function(){a.syncResult.localDataUpdated=a.syncResult.nbUpdated>0,a.syncResult.syncOK=!0,a.syncResult.codeStr="syncOk",a.syncResult.message="Data synchronized successfully. ("+a.syncResult.nbUpdated+" updated)"})})})},createDialog:function(){this.diaSync=new sap.m.Dialog({contentHeight:"250px",contentWidth:"200px",title:"Syncronization"});var n=new sap.m.Table({fixedLayout:!1});this.diaSync.addContent(n);var e=new sap.m.Column({width:"40px"});n.addColumn(e);var t=new sap.m.Column;n.addColumn(t);var a=new sap.m.Column({hAlign:"End",width:"50px"});n.addColumn(a);var c=new sap.m.ColumnListItem;n.addItem(c),this.diaSyncIcon1=new sap.ui.core.Icon({size:"20px"}),c.addCell(this.diaSyncIcon1);var s=new sap.m.Text({text:"Select"});c.addCell(s),this.diaSyncCount1=new sap.m.BusyIndicator,c.addCell(this.diaSyncCount1);var i=new sap.m.ColumnListItem;n.addItem(i),this.diaSyncIcon2=new sap.ui.core.Icon({size:"20px"}),i.addCell(this.diaSyncIcon2);var o=new sap.m.Text({text:"Receive"});i.addCell(o),this.diaSyncCount2=new sap.m.Text,i.addCell(this.diaSyncCount2);var l=new sap.m.ColumnListItem;n.addItem(l),this.diaSyncIcon3=new sap.ui.core.Icon({size:"20px"}),l.addCell(this.diaSyncIcon3);var r=new sap.m.Text({text:"Update"});l.addCell(r),this.diaSyncCount3=new sap.m.Text,l.addCell(this.diaSyncCount3);var d=new sap.m.ColumnListItem;n.addItem(d),this.diaSyncIcon4=new sap.ui.core.Icon({src:"sap-icon://number-sign",size:"20px"}),d.addCell(this.diaSyncIcon4);var u=new sap.m.Text({text:"Records"});d.addCell(u),this.diaSyncCount4=new sap.m.Text,d.addCell(this.diaSyncCount4),this.diaSyncCount2.setText(this.recPackage+"/"+this.numPackage),this.diaSyncCount3.setText(this.updPackage+"/"+this.numPackage),this.diaSyncCount4.setText("0"),this.diaSyncIcon1.setSrc("sap-icon://process"),this.diaSyncIcon2.setSrc("sap-icon://process"),this.diaSyncIcon3.setSrc("sap-icon://process"),this.diaSyncIcon1.setColor("#f39c12"),this.diaSyncIcon2.setColor("#f39c12"),this.diaSyncIcon3.setColor("#f39c12"),this.diaSync.rerender(),this.diaSync.open()},log:function(n){},error:function(n){console.error(n)},resetSyncDate:function(){this.syncInfo.lastSyncDate=0,this.firstSync=!0,this._executeSql('UPDATE SYNCINFO SET last_sync = "0" WHERE key=?',[this.applid])},_getDataToBackup:function(n){var e=this;e.log("_getDataToBackup");var t={info:e.syncInfo,data:{}};n(t)},_sendDataToServer:function(n,e){var t=this;t.log(n),jQuery.ajax({url:t.serverUrl+"&key=BUILD&ajax_value="+t.numPackage,type:"POST",data:JSON.stringify(n),dataType:"json",complete:function(n){t.log("Server answered: "),t.log(n)},success:function(a){for(t.diaSyncCount4.setText(a.rows),t.diaSyncIcon1.setColor("#007833"),t.diaSyncIcon1.setSrc("sap-icon://accept"),AppSyncBeforeUpdate(),1===t.numPackage&&e(a),i=0;i<t.numPackage;i++)t._getPackageFromServer(n,e,i)},error:function(n){t.diaSync.close(),n.result="ERROR",n.message=n.statusText,e(n)}})},_getPackageFromServer:function(n,e,t){var a=this;a.log(n),jQuery.ajax({url:a.serverUrl+"&key=GET&key_id="+t,type:"POST",data:JSON.stringify(n),dataType:"json",success:function(n){a.recPackage++,a.diaSyncCount2.setText(a.recPackage+"/"+a.numPackage),a.diaSyncCount1.setVisible(!1),a.recPackage===a.numPackage&&(a.diaSyncIcon2.setColor("#007833"),a.diaSyncIcon2.setSrc("sap-icon://accept"),a.cbEndSync(a.syncResult)),e(n)},error:function(n){a.diaSync.close(),n.result="ERROR",n.message=n.statusText,e(n)}})},_updateLocalDb:function(n,e){var t=this;return n&&"ERROR"!==n.result?"undefined"==typeof n.data||0===n.data.length?void t.db.transaction(function(a){t._finishSync(n.syncDate,a,e(0))}):void t.db.transaction(function(a){t.tablesToSync.length;t.tablesToSync.forEach(function(e){var c=n.data[e.tableName]||[],s=c.slice(1,c[0]+1),i=0,o="",l=!1;c=c.slice(parseInt(c[0])+1,c.length);var r="INSERT OR REPLACE INTO "+e.tableName+" (",d="",u=0;r+=t._arrayToString(s,","),r+=") SELECT ",o=r,$.each(c,function(n,e){u===s.length&&(d="",u=0,l=!0,i++,i===AppSync.sqlSplit?(t._executeSql(o,null,a),o=r,i=0,l=!1):o+=" UNION SELECT "),u++,o+=d+'"'+e+'"',d=","}),(l||c.length===s.length)&&t._executeSql(o,null,a)}),t.updPackage++,t._finishSync(n.syncDate,a,e),t.diaSyncCount3.setText(t.updPackage+"/"+t.numPackage),t.updPackage===t.numPackage&&(AppSyncAfterUpdate(),t.diaSyncIcon3.setColor("#007833"),t.diaSyncIcon3.setSrc("sap-icon://accept"),setTimeout(function(){t.diaSync.close()},200))}):(t.syncResult.syncOK=!1,t.syncResult.codeStr="syncKoServer",n?t.syncResult.message=n.message:t.syncResult.message="No answer from the server",void t.cbEndSync(t.syncResult))},_finishSync:function(n,e,t){this.firstSync=!1,this.lastSyncDate=n,this.syncInfo.lastSyncDate=this.lastSyncDate,this._executeSql('UPDATE SYNCINFO SET last_sync = "'+this.lastSyncDate+'" WHERE key=?',[this.applid],e),t()},_selectSql:function(n,e,t,a){var c=this;c._executeSql(n,e,t,function(n,e){a(c._transformRs(e))},c._errorHandler)},_transformRs:function(n){var e=[];if("undefined"==typeof n.rows)return e;for(var t=0;t<n.rows.length;++t)e.push(n.rows.item(t));return e},_executeSql:function(n,e,t,a){var c=this;c.log("_executeSql: "+n+" with param "+e),a||(a=c._defaultCallBack),t?c._executeSqlBridge(t,n,e,a,c._errorHandler):c.db.transaction(function(t){c._executeSqlBridge(t,n,e,a,c._errorHandler)})},_executeSqlBridge:function(n,e,t,a,c){var s=this;if("undefined"!=typeof s.db.dbPath){var i=[e].concat(t),o=function(e){e.rows.item=function(n){return this[n]},a(n,e)};n.executeSql(i,o,c)}else n.executeSql(e,t,a,c)},_defaultCallBack:function(n,e){},_errorHandler:function(n,e){AppSync.error("Error : "+e.message+" (Code "+e.code+") Transaction.sql = "+n.sql)},_arrayToString:function(n,e){for(var t="",a=0;a<n.length;a++)t+=n[a],a<n.length-1&&(t+=e);return t}};